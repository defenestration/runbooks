<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="etcdHighFsyncDurations # Meaning # This alert fires when the 99th percentile of etcd disk fsync duration is too high for 10 minutes.
Full context Every write request sent to etcd has to be [fsync&rsquo;d][fsync] to disk by the leader node, transmitted to its peers, and fsync&rsquo;d to those disks as well before etcd can tell the client that the write request succeeded (as part of the [Raft consensus algorithm][raft]). As a result of all those fsync&rsquo;s, etcd cares a LOT about disk latency, which this alert picks up on."><meta name=theme-color content="#FFFFFF"><meta property="og:title" content><meta property="og:description" content="etcdHighFsyncDurations # Meaning # This alert fires when the 99th percentile of etcd disk fsync duration is too high for 10 minutes.
Full context Every write request sent to etcd has to be [fsync&rsquo;d][fsync] to disk by the leader node, transmitted to its peers, and fsync&rsquo;d to those disks as well before etcd can tell the client that the write request succeeded (as part of the [Raft consensus algorithm][raft]). As a result of all those fsync&rsquo;s, etcd cares a LOT about disk latency, which this alert picks up on."><meta property="og:type" content="article"><meta property="og:url" content="https://defenestration.github.io/runbooks/runbooks/etcd/etcdhighfsyncdurations/"><meta property="article:section" content="runbooks"><title>Etcd High Fsync Durations | kube-prometheus runbooks</title><link rel=manifest href=/runbooks/manifest.json><link rel=icon href=/runbooks/favicon.png type=image/x-icon><link rel=stylesheet href=/runbooks/book.min.958cea7827621d6fbcb3acf091344c3e44e3d2a9428f9c3c38bb9eb37bf8c45d.css integrity="sha256-lYzqeCdiHW+8s6zwkTRMPkTj0qlCj5w8OLues3v4xF0=" crossorigin=anonymous><script defer src=/runbooks/flexsearch.min.js></script>
<script defer src=/runbooks/en.search.min.bf087d356c72e0d10d8d4f219675389fb4ae60fa963168b012a91d6d18f19dec.js integrity="sha256-vwh9NWxy4NENjU8hlnU4n7SuYPqWMWiwEqkdbRjxnew=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a href=/runbooks/><span>kube-prometheus runbooks</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li class=book-section-flat><input type=checkbox id=section-77747a9d3152fa2d9804f647f1c86ce5 class=toggle>
<label for=section-77747a9d3152fa2d9804f647f1c86ce5 class="flex justify-between"><a role=button>general</a></label><ul><li><a href=https://defenestration.github.io/runbooks/runbooks/general/infoinhibitor/>Info Inhibitor</a></li><li><a href=https://defenestration.github.io/runbooks/runbooks/general/nodenetworkinterfaceflapping/>Node Network Interface Flapping</a></li><li><a href=https://defenestration.github.io/runbooks/runbooks/general/watchdog/>Watchdog</a></li><li><a href=https://defenestration.github.io/runbooks/runbooks/general/targetdown/>Target Down</a></li></ul></li><li class=book-section-flat><input type=checkbox id=section-8a9628b913ed2d2ebcb204a774d910f4 class=toggle>
<label for=section-8a9628b913ed2d2ebcb204a774d910f4 class="flex justify-between"><a role=button>alertmanager</a></label><ul><li><a href=https://defenestration.github.io/runbooks/runbooks/alertmanager/alertmanagerclustercrashlooping/>Alertmanager Cluster Crashlooping</a></li><li><a href=https://defenestration.github.io/runbooks/runbooks/alertmanager/alertmanagerclusterdown/>Alertmanager Cluster Down</a></li><li><a href=https://defenestration.github.io/runbooks/runbooks/alertmanager/alertmanagerclusterfailedtosendalerts/>Alertmanager Cluster Failed To Send Alerts</a></li><li><a href=https://defenestration.github.io/runbooks/runbooks/alertmanager/alertmanagerconfiginconsistent/>Alertmanager ConfigInconsistent</a></li><li><a href=https://defenestration.github.io/runbooks/runbooks/alertmanager/alertmanagerfailedtosendalerts/>Alertmanager Failed To Send Alerts</a></li><li><a href=https://defenestration.github.io/runbooks/runbooks/alertmanager/alertmanagermembersinconsistent/>Alertmanager Members Inconsistent</a></li><li><a href=https://defenestration.github.io/runbooks/runbooks/alertmanager/alertmanagerfailedreload/>AlertmanagerFailedReload</a></li></ul></li><li class=book-section-flat><input type=checkbox id=section-a3239edffad56d0bac2aa416aa6229aa class=toggle checked>
<label for=section-a3239edffad56d0bac2aa416aa6229aa class="flex justify-between"><a role=button>etcd</a></label><ul><li><a href=https://defenestration.github.io/runbooks/runbooks/etcd/etcdbackendquotalowspace/>Etcd Backend Quota Low Space</a></li><li><a href=https://defenestration.github.io/runbooks/runbooks/etcd/etcdgrpcrequestsslow/>Etcd Grpcrequests Slow</a></li><li><a href=https://defenestration.github.io/runbooks/runbooks/etcd/etcdhighfsyncdurations/ class=active>Etcd High Fsync Durations</a></li><li><a href=https://defenestration.github.io/runbooks/runbooks/etcd/etcdhighnumberoffailedgrpcrequests/>Etcd High Number of Failed Grpcrequests</a></li><li><a href=https://defenestration.github.io/runbooks/runbooks/etcd/etcdinsufficientmembers/>Etcd Insufficient Members</a></li><li><a href=https://defenestration.github.io/runbooks/runbooks/etcd/etcdmembersdown/>Etcd Members Down</a></li><li><a href=https://defenestration.github.io/runbooks/runbooks/etcd/etcdnoleader/>Etcd No Leader</a></li></ul></li><li class=book-section-flat><input type=checkbox id=section-5985c1df24eaf5f98ff50cd2aba6514b class=toggle>
<label for=section-5985c1df24eaf5f98ff50cd2aba6514b class="flex justify-between"><a role=button>kube-state-metrics</a></label><ul></ul></li><li class=book-section-flat><input type=checkbox id=section-96dded8b3c9feb1c3fa3dff530c60250 class=toggle>
<label for=section-96dded8b3c9feb1c3fa3dff530c60250 class="flex justify-between"><a role=button>kubernetes</a></label><ul><li><a href=https://defenestration.github.io/runbooks/runbooks/kubernetes/kubeapidown/>Kube API Down</a></li><li><a href=https://defenestration.github.io/runbooks/runbooks/kubernetes/kubeapierrorbudgetburn/>Kube API Error Budget Burn</a></li><li><a href=https://defenestration.github.io/runbooks/runbooks/kubernetes/kubejobfailed/>Kube Job Failed</a></li><li><a href=https://defenestration.github.io/runbooks/runbooks/kubernetes/kubeletdown/>Kubelet Down</a></li><li><a href=https://defenestration.github.io/runbooks/runbooks/kubernetes/kubelettoomanypods/>Kubelet Too Many Pods</a></li><li><a href=https://defenestration.github.io/runbooks/runbooks/kubernetes/kubenodenotready/>Kube Node Not Ready</a></li><li><a href=https://defenestration.github.io/runbooks/runbooks/kubernetes/kubepersistentvolumefillingup/>Kube Persistent Volume Filling Up</a></li><li><a href=https://defenestration.github.io/runbooks/runbooks/kubernetes/kubeschedulerdown/>Kube Scheduler Down</a></li></ul></li><li class=book-section-flat><input type=checkbox id=section-c29e8d824e17b7d901bc170a7d0435b2 class=toggle>
<label for=section-c29e8d824e17b7d901bc170a7d0435b2 class="flex justify-between"><a role=button>node</a></label><ul><li><a href=https://defenestration.github.io/runbooks/runbooks/node/nodefiledescriptorlimit/>Node File Descriptor Limit</a></li><li><a href=https://defenestration.github.io/runbooks/runbooks/node/nodefilesystemalmostoutoffiles/>Node Filesystem Almost Out of Files</a></li><li><a href=https://defenestration.github.io/runbooks/runbooks/node/nodefilesystemalmostoutofspace/>Node Filesystem Almost Out of Space</a></li><li><a href=https://defenestration.github.io/runbooks/runbooks/node/nodefilesystemfilesfillingup/>Node Filesystem Files Filling Up</a></li><li><a href=https://defenestration.github.io/runbooks/runbooks/node/nodefilesystemspacefillingup/>Node Filesystem Space Filling Up</a></li><li><a href=https://defenestration.github.io/runbooks/runbooks/node/noderaiddegraded/>Node Raiddegraded</a></li></ul></li><li class=book-section-flat><input type=checkbox id=section-67010990d531fdafbd578205491897d5 class=toggle>
<label for=section-67010990d531fdafbd578205491897d5 class="flex justify-between"><a role=button>prometheus</a></label><ul><li><a href=https://defenestration.github.io/runbooks/runbooks/prometheus/prometheusbadconfig/>Prometheus Bad Config</a></li><li><a href=https://defenestration.github.io/runbooks/runbooks/prometheus/prometheusduplicatetimestamps/>Prometheus Duplicate Timestamps</a></li><li><a href=https://defenestration.github.io/runbooks/runbooks/prometheus/prometheusoutofordertimestamps/>Prometheus Out of Order Timestamps</a></li><li><a href=https://defenestration.github.io/runbooks/runbooks/prometheus/prometheusrulefailures/>Prometheus Rule Failures</a></li><li><a href=https://defenestration.github.io/runbooks/runbooks/prometheus/prometheustargetsyncfailure/>Prometheus Target Sync Failure</a></li></ul></li><li class=book-section-flat><input type=checkbox id=section-10a9331d031c9e488862183af9bf7d32 class=toggle>
<label for=section-10a9331d031c9e488862183af9bf7d32 class="flex justify-between"><a role=button>prometheus-operator</a></label><ul></ul></li></ul><ul><li><a href=/runbooks/docs/add-runbook/>Add Runbook</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/runbooks/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Etcd High Fsync Durations</strong>
<label for=toc-control><img src=/runbooks/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#meaning>Meaning</a></li><li><a href=#impact>Impact</a></li><li><a href=#diagnosis>Diagnosis</a><ul><li><a href=#slow-disk>Slow disk</a></li></ul></li><li><a href=#mitigation>Mitigation</a><ul><li><a href=#fragmented-state>Fragmented state</a></li></ul></li></ul></nav></aside></header><article class=markdown><h1 id=etcdhighfsyncdurations>etcdHighFsyncDurations
<a class=anchor href=#etcdhighfsyncdurations>#</a></h1><h2 id=meaning>Meaning
<a class=anchor href=#meaning>#</a></h2><p>This alert fires when the 99th percentile of etcd disk fsync duration is too
high for 10 minutes.</p><details><summary>Full context</summary><p>Every write request sent to etcd has to be [fsync&rsquo;d][fsync] to disk by the leader node, transmitted to its peers, and fsync&rsquo;d to those disks as well before etcd can tell the client that the write request succeeded (as part of the [Raft consensus algorithm][raft]). As a result of all those fsync&rsquo;s, etcd cares a LOT about disk latency, which this alert picks up on.</p><p>Etcd instances perform poorly on network-attached storage. Directly-attached spinning disks may work, but solid-state disks or better [are recommended][etcd-disks] for larger clusters. For very large clusters, you may even consider a [separate etcd cluster just for events][etcd-events] to reduce the write load.</p></details><h2 id=impact>Impact
<a class=anchor href=#impact>#</a></h2><p>When this happens it can lead to various scenarios like leader election failure,
frequent leader elections, slow reads and writes.</p><h2 id=diagnosis>Diagnosis
<a class=anchor href=#diagnosis>#</a></h2><p>This could be result of slow disk possibly due to fragmented state in etcd or
simply due to slow disk.</p><h3 id=slow-disk>Slow disk
<a class=anchor href=#slow-disk>#</a></h3><p>Checking disk related metrics and dashboards should provide a more clear
picture.</p><h4 id=promql-queries-used-to-troubleshoot>PromQL queries used to troubleshoot
<a class=anchor href=#promql-queries-used-to-troubleshoot>#</a></h4><p><code>etcd_disk_wal_fsync_duration_seconds_bucket</code> reports the etcd disk fsync
duration, <code>etcd_server_leader_changes_seen_total</code> reports the leader changes. To
rule out a slow disk and confirm that the disk is reasonably fast, 99th
percentile of the <code>etcd_disk_wal_fsync_duration_seconds_bucket</code> should be less
than 10ms. Query in metrics UI:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-promql data-lang=promql><span style=display:flex><span><span style=color:#66d9ef>histogram_quantile</span><span style=color:#f92672>(</span><span style=color:#ae81ff>0.99</span>, <span style=color:#66d9ef>sum</span> <span style=color:#66d9ef>by</span> <span style=color:#f92672>(</span>instance, le<span style=color:#f92672>)</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>irate</span><span style=color:#f92672>(</span>etcd_disk_wal_fsync_duration_seconds_bucket{job<span style=color:#f92672>=</span>&#34;<span style=color:#e6db74>etcd</span>&#34;}[<span style=color:#e6db74>5m</span>]<span style=color:#f92672>)))</span>
</span></span></code></pre></div><h2 id=mitigation>Mitigation
<a class=anchor href=#mitigation>#</a></h2><h3 id=fragmented-state>Fragmented state
<a class=anchor href=#fragmented-state>#</a></h3><p>In the case of slow fisk or when the etcd DB size increases, we can defragment
existing etcd DB to optimize DB consumption as described in
[here][etcdDefragmentation]. Run the following command in all etcd pods.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ etcdctl defrag
</span></span></code></pre></div><p>As validation, check the endpoint status of etcd members to know the reduced
size of etcd DB. Use for this purpose the same diagnostic approaches as listed
above. More space should be available now.</p><p>Further info on etcd best practices can be found in the [OpenShift docs
here][etcdPractices].</p><ul><li><a href=https://man7.org/linux/man-pages/man2/fsync.2.html>fsync</a></li><li><a href=https://en.wikipedia.org/wiki/Raft_%28algorithm%29#Log_replication>raft</a></li><li><a href=https://etcd.io/docs/v3.5/op-guide/hardware/#disks>etcd-disks</a></li><li><a href=https://github.com/kubernetes/kubernetes/issues/4432>etcd-events</a></li><li><a href=https://etcd.io/docs/v3.4.0/op-guide/maintenance/>etcdDefragmentation</a></li><li><a href=https://docs.openshift.com/container-platform/4.7/scalability_and_performance/recommended-host-practices.html#recommended-etcd-practices_>etcdPractices</a></li></ul></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/defenestration/runbooks/edit/main/content/runbooks/etcd/etcdHighFsyncDurations.md target=_blank rel=noopener><img src=/runbooks/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#meaning>Meaning</a></li><li><a href=#impact>Impact</a></li><li><a href=#diagnosis>Diagnosis</a><ul><li><a href=#slow-disk>Slow disk</a></li></ul></li><li><a href=#mitigation>Mitigation</a><ul><li><a href=#fragmented-state>Fragmented state</a></li></ul></li></ul></nav></div></aside></main></body></html>